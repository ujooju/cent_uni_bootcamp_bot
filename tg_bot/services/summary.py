import asyncio
import re
from aiogram import Bot, Dispatcher, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from datetime import datetime, timedelta
import pytz
from sqlalchemy import select
from sqlalchemy.orm import sessionmaker
from tg_bot.models import engine, Message
from yandex_cloud_ml_sdk import YCloudML
import time
import requests
import os

TOKEN = os.getenv("TOKEN")
YANDEX_FOLDER_ID = os.getenv("YANDEX_FOLDER_ID")
YANDEX_API_KEY = os.getenv("YANDEX_API_KEY")

sdk = YCloudML(folder_id=YANDEX_FOLDER_ID, auth=YANDEX_API_KEY)
def check_data(i, today_date, type_text):

    days = int(type_text)
    
    date_match = re.search(r'\*\*–î–∞—Ç–∞\*\*: (\d{2}\.\d{2}\.\d{4})', i)
    if not date_match:
        return i
    event_date = datetime.strptime(date_match.group(1), "%d.%m.%Y")
    today = datetime.strptime(today_date, "%d.%m.%Y")
    min_date = today
    max_date = today + timedelta(days=days) 
    if min_date <= event_date <= max_date:
        return i
    else:
        return ""
    
def remove_first_line(i):
    lines = i.split("\n")
    if len(lines) > 1:
        return "\n".join(lines[1:])
    else:
        return i
    
def check_category(i, type_text):
    category = i.split("\n")[0].split(":")[-1].strip() 
    
    type2_text = {
        "deadlines": "–¥–µ–¥–ª–∞–π–Ω—ã",
        "dosug": "–ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –¥–æ—Å—É–≥–∞",
        "networking": "–Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∏"
    }
    if category not in ["–î–µ–¥–ª–∞–π–Ω", "–î–æ—Å—É–≥", "–ù–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥"]:
        return remove_first_line(i)
    if category == "–î–µ–¥–ª–∞–π–Ω" and type_text != type2_text["deadlines"]:
        print("WRONG", type_text, type2_text["deadlines"])
        return ""
    elif category == "–î–æ—Å—É–≥" and type_text != type2_text["dosug"]:
        print("WRONG", type_text, type2_text["dosug"])
        return ""
    elif category == "–ù–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥" and type_text != type2_text["networking"]:
        print("WRONG", type_text, type2_text["networking"])
        return ""

    return remove_first_line(i)

async def get_chat_history(chat_id: int) -> list:
    try:
        session = sessionmaker(bind=engine)()
        result = session.query(Message).filter(Message.chat_id == chat_id).all()
        session.close()
        return [
            {"text": msg.message_text, "date": msg.timestamp, "link": msg.link}
            for msg in result
        ]
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: {e}")
        return []
    finally:
        try:
            session.close()
        except:
            pass
async def yandex_gpt_summarize(text: str, type_text: str, type2_text: str, message: types.Message=None, percent=None) -> str:
    today_date = datetime.now(pytz.timezone("Europe/Moscow")).strftime("%d.%m.%Y")
    system_prompt = system_prompt = f"""
        –¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ –Ω–∏—Ö –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
        –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ –≤—Å–µ —Ç–æ—á–Ω—ã–µ {type2_text} –∑–∞ —Å–ª–µ–¥—É—é—â–∏–µ {type_text} –¥–Ω–µ–π –∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è, –≤—ã–¥–µ–ª–∏–≤ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞.
        !–ó–ê–ú–ï–ù–ò –í–°–ï –ú–ê–¢–ù–´–ï –ò –ù–ï–¶–ï–ù–ó–£–†–ù–´–ï –°–õ–û–í–ê –ù–ê ****
        ‚ö†Ô∏è –í–ê–ñ–ù–û:
        ### 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π:

        - **–ù–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥**: –≠—Ç–æ –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ–ª–æ–≤—ã—Ö —Å–≤—è–∑–µ–π. –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:
        - –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å—Ç–≤–æ, –∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ, –≤—Å—Ç—Ä–µ—á–∞, –≤—Å—Ç—Ä–µ—á–∞ —Å –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º–∏, –¥–µ–ª–æ–≤—ã–µ —Å–≤—è–∑–∏, —Ä–∞–∑–≤–∏—Ç–∏–µ, —É—á–∞—Å—Ç–∏–µ, –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è, —Å–µ–º–∏–Ω–∞—Ä, —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∞, —Ä–∞–∑–≤–∏—Ç–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤, —Ç—Ä–µ–Ω–∏–Ω–≥, –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å, –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥, –∫–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç.
        
        - **–î–µ–¥–ª–∞–π–Ω**: –≠—Ç–æ —Å—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á, —Å–¥–∞—á–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤. –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:
        - –¥–µ–¥–ª–∞–π–Ω, —Å–¥–∞—á–∞, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è, —Å—Ç–æ–ø–∫–æ–¥–∏–Ω–≥, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã, —Å—Ä–æ–∫, –∫—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫, —Å–¥–∞—á–∞ –æ—Ç—á—ë—Ç–∞, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã, –æ—Ç—á–∏—Ç–∞—Ç—å—Å—è, –æ–∫–æ–Ω—á–∞–Ω–∏–µ, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –ø—Ä–æ–µ–∫—Ç.

        - **–î–æ—Å—É–≥**: –≠—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –æ—Ç–¥—ã—Ö–æ–º, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è–º–∏ –∏ –∞–∫—Ç–∏–≤–Ω—ã–º –æ—Ç–¥—ã—Ö–æ–º. –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:
        - —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ, –æ—Ç–¥—ã—Ö, –∫—É–ª—å—Ç—É—Ä–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ, –∫–æ–Ω—Ü–µ—Ä—Ç, –≤—ã—Å—Ç–∞–≤–∫–∞, –≤—Å—Ç—Ä–µ—á–∞ —Å –¥—Ä—É–∑—å—è–º–∏, –∞–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–¥—ã—Ö, —Ç—É—Ä–∏–∑–º, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ, –∫–∏–Ω–æ, —Ç–µ–∞—Ç—Ä, —Å–ø–æ—Ä—Ç, –≤–µ—á–µ—Ä–∏–Ω–∫–∏, —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ, –æ—Ç–¥—ã—Ö –Ω–∞ –ø—Ä–∏—Ä–æ–¥–µ, –∏–≥—Ä–∞

        ### 2. –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

        1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏**:
        - –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏–∑ –æ–¥–Ω–æ–π –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π. –ï—Å–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç, –æ—Ç–Ω–µ—Å–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
        
        2. **–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —è–≤–Ω—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤**:
        - –ü—Ä–æ—á–∏—Ç–∞–π —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –ø–æ–Ω—è—Ç—å, –∫ –∫–∞–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤–∞–∂–Ω–æ–π –≤—Å—Ç—Ä–µ—á–µ –∏–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ –¥–ª—è –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞, –æ—Ç–Ω–µ—Å–∏ —ç—Ç–æ –∫ **–ù–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥—É**.
        - –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–æ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Å—Ä–æ–∫–æ–º –∏–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º, –æ—Ç–Ω–µ—Å–∏ –µ–≥–æ –∫ **–î–µ–¥–ª–∞–π–Ω—É**.
        - –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞—Å–∞–µ—Ç—Å—è –ª–∏—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è, –∏–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ –æ—Ç–¥—ã—Ö, –æ—Ç–Ω–µ—Å–∏ –µ–≥–æ –∫ **–î–æ—Å—É–≥—É**.

        3. **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π**:
        - –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏–º–µ–µ—Ç —è–≤–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏–∑ –æ–¥–Ω–æ–π –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –Ω–µ –Ω–µ—Å—ë—Ç –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –æ—Å—Ç–∞–≤—å –æ—Ç–≤–µ—Ç –ø—É—Å—Ç—ã–º.
        
        4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã**:
        - –ï—Å–ª–∏ –¥–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–µ {type_text} –¥–Ω–∏ –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º –∏–ª–∏ –∑–∞–≤—Ç—Ä–∞—à–Ω–∏–º –¥–Ω–µ–º, –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ.
        - –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç—ã.
        - –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∫–∞–∑–∞–Ω–æ –∫–∞–∫ "—Å–µ–≥–æ–¥–Ω—è" –∏–ª–∏ "–∑–∞–≤—Ç—Ä–∞", –æ—Ç–æ–±—Ä–∞–∂–∞–π —Ç–æ–ª—å–∫–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —ç—Ç–∏—Ö –¥–Ω–µ–π.

        5. **–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è**:
        - –í–∞–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏—è, –∞ –Ω–µ –¥–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è. –î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏. –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏—è –Ω—É–∂–Ω–æ –≤ —Å—Ç—Ä–æ–≥–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì.
        
        6. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–æ–∫**:
        - –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–∫–∞–∑–∞–Ω–∞ —Å—Å—ã–ª–∫–∞, –¥–æ–±–∞–≤—å –µ—ë –≤ –æ—Ç–≤–µ—Ç.
        - –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ —É–∫–∞–∑–∞–Ω–∞ –∫–∞–∫ "None", –∏–≥–Ω–æ—Ä–∏—Ä—É–π –µ—ë –∏ –Ω–µ –¥–æ–±–∞–≤–ª—è–π –≤ –æ—Ç–≤–µ—Ç.

        7. **–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞**:
        - **–î–∞—Ç–∞**: [–¥–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì]
        - **–û–ø–∏—Å–∞–Ω–∏–µ**: [–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è]
        - **–¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è**: [–µ—Å–ª–∏ –≤—Ä–µ–º—è —É–∫–∞–∑–∞–Ω–æ, —Ç–æ —Ç–∞–∫–∂–µ –≤–∫–ª—é—á–∞–π]
        - **–°—Å—ã–ª–∫–∞**: [–µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –µ—Å—Ç—å –∏ –Ω–µ —Ä–∞–≤–Ω–∞ None, –¥–æ–±–∞–≤–ª—è–π –µ—ë]

        8. **–ü—Ä–∏–º–µ—Ä 1**:
        –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–∫–∞–∑–∞–Ω–æ:
        - "–í—Å—Ç—Ä–µ—á–∞ –¥–ª—è –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –±–∏–∑–Ω–µ—Å–∞ –≤ —Å—É–±–±–æ—Ç—É, 10.02.2025. –ú–µ—Å—Ç–æ: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –Ω–∞—á–∞–ª–æ –≤ 14:00"
            - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è**: –ù–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥
            - **–î–∞—Ç–∞**: 10.02.2025
            - **–û–ø–∏—Å–∞–Ω–∏–µ**: –í—Å—Ç—Ä–µ—á–∞ –¥–ª—è –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤ –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –±–∏–∑–Ω–µ—Å–∞
            - **–¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è**: 14:00
            - **–°—Å—ã–ª–∫–∞**: (–µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –µ—Å—Ç—å)

        9. **–ü—Ä–∏–º–µ—Ä 2**:
        –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–∫–∞–∑–∞–Ω–æ:
        - "–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫ –¥–ª—è —Å–¥–∞—á–∏ –æ—Ç—á—ë—Ç–∞ 12.02.2025. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ 17:00"
            - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è**: –î–µ–¥–ª–∞–π–Ω
            - **–î–∞—Ç–∞**: 12.02.2025
            - **–û–ø–∏—Å–∞–Ω–∏–µ**: –°–¥–∞—á–∞ –æ—Ç—á—ë—Ç–∞
            - **–¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è**: 17:00
            - **–°—Å—ã–ª–∫–∞**: None (–µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)

        10. **–ü—Ä–∏–º–µ—Ä 3**:
        –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–∫–∞–∑–∞–Ω–æ:
        - "–í—ã—Å—Ç–∞–≤–∫–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞ –≤ –≥–∞–ª–µ—Ä–µ–µ, 11.02.2025, –Ω–∞—á–∞–ª–æ –≤ 18:00"
            - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è**: –î–æ—Å—É–≥
            - **–î–∞—Ç–∞**: 11.02.2025
            - **–û–ø–∏—Å–∞–Ω–∏–µ**: –í—ã—Å—Ç–∞–≤–∫–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞
            - **–¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è**: 18:00
            - **–°—Å—ã–ª–∫–∞**: (–µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –µ—Å—Ç—å)

        #### –í–ê–ñ–ù–û:
        - –ï—Å–ª–∏ –¥–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ {type_text} (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –±–ª–∏–∂–∞–π—à–∏—Ö {type_text} –¥–Ω–µ–π), –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ.
        - –°—Ç—Ä–æ–≥–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã, –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å—Å—ã–ª–∫–∏.
        - –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, –≤—ã–±–µ—Ä–∏ —Ç—É, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è —Å–¥–∞—á–∞ —Ä–∞–±–æ—Ç—ã –∏ —Å–µ–º–∏–Ω–∞—Ä, —Ç–æ –æ—Ç–Ω–µ—Å–∏ –µ–≥–æ –∫ **–î–µ–¥–ª–∞–π–Ω—É**, –∞ –Ω–µ –∫ **–ù–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥—É**.
        - –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç {type2_text}, —Ç–æ –Ω–µ –Ω–∞–¥–æ –µ—ë –¥–æ–±–∞–≤–ª—è—Ç—å!!!
        - –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, –¢–û –ù–ï –ù–ê–î–û –ò–• –î–û–ë–ê–í–õ–Ø–¢–¨!!!
        !!!! –ü–û–ú–ù–ò! –í–´–ü–û–õ–ù–Ø–ô –í–°–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –í–´–®–ï !!!!!

        –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ):
        **–ö–∞—Ç–µ–≥–æ—Ä–∏—è**: [–∫–∞—Ç–µ–≥–æ—Ä–∏—è]
        **–î–∞—Ç–∞**: [–¥–∞—Ç–∞]
        **–û–ø–∏—Å–∞–Ω–∏–µ**: [–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ]
        **–¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è**: [–≤—Ä–µ–º—è, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ]
        **–°—Å—ã–ª–∫–∞**: [—Å—Å—ã–ª–∫–∞, –µ—Å–ª–∏ –∏–º–µ–µ—Ç—Å—è –∏ –Ω–µ —Ä–∞–≤–Ω–∞ None]
        """



    body = {
        "modelUri": f"gpt://{YANDEX_FOLDER_ID}/yandexgpt-32k/rc",
        "completionOptions": {"stream": False, "temperature": 0.3, "maxTokens": 20000},
        "messages": [
            {"role": "system", "text": system_prompt},
            {"role": "user", "text": text},
        ],
    }
    
    url = "https://llm.api.cloud.yandex.net/foundationModels/v1/completionAsync"
    headers = {"Content-Type": "application/json", "Authorization": f"Api-Key {YANDEX_API_KEY}"}
    
    response = requests.post(url, headers=headers, json=body)
    print(response)
    print(response.text)
    operation_id = response.json().get("id")
    if message:
        await message.edit_text(f"‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π: {percent}%")
    
    while True:
        response = requests.get(f"https://llm.api.cloud.yandex.net:443/operations/{operation_id}", headers=headers)
        if response.json().get("done"):
            break
        time.sleep(0.5)
    data = response.json()["response"]["alternatives"][0]["message"]["text"].split("\n\n")
    text = ""
    for i in data:
        l = False
        if "**–ö–∞—Ç–µ–≥–æ—Ä–∏—è**" in i:
            data = check_category(i, type2_text)
            i = data
        if "**–î–∞—Ç–∞**" in i:
            data = check_data(i, today_date, type_text)
            i = data
        if "**–°—Å—ã–ª–∫–∞**: None" in i:
            l = True
            text += i.replace("**–°—Å—ã–ª–∫–∞**: None", "") + "\n\n"
        if not l and i != "":
            text += i + "\n\n"
    
    return text

async def summarize_messages(messages: list, type_text: str, type2_text: str, max_percent: int, percent_now:int, message: types.Message, batch_size: int = 50) -> str:
    unique_messages = []
    seen_texts = set() 

    for msg in messages:
        if msg["text"] not in seen_texts:
            unique_messages.append(msg)
            seen_texts.add(msg["text"])
    all_text = "\n".join([f'[{msg["text"]}] - [{msg["date"]}] - [{msg["link"]}]' for msg in unique_messages])
    progress = (max_percent + percent_now*2)//3
    await message.edit_text(f"‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π: {progress}%")
    progress = (max_percent*2 + percent_now)//3
    summary = await yandex_gpt_summarize(all_text, type_text, type2_text, message, progress)
    
    return summary

async def process_chat_summary(chats: list[int], user_id: int, days: str, category: str, bot: Bot, message: types.Message):
    type_text = {"period_month": "31", "period_week": "7", "period_day": "1"}.get(days, "1")
    type2_text = {"deadlines": "–¥–µ–¥–ª–∞–π–Ω—ã", "dosug": "–ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –¥–æ—Å—É–≥–∞", "networking": "–Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∏"}.get(category, "—Å–æ–±—ã—Ç–∏—è")
    # await message.edit_reply_markup()
    message = await message.edit_text(f"‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ {type_text}...")
    summaries = []
    total_chats = len(chats)
    
    for index, chat_id in enumerate(chats, start=1):
        messages = await get_chat_history(chat_id)
        if messages:
            max_percent = (index / total_chats) * 100
            percent_now = ((index-1) / total_chats) * 100
            summary = await summarize_messages(messages, type_text, type2_text, max_percent, percent_now, message)
            if summary.strip():
                summaries.append(summary)
        progress = round((index / total_chats) * 100)
        await message.edit_text(f"‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π: {progress}%")
    
    if summaries:
        final_summary = "\n------------------------------\n".join(summaries)
        await message.edit_text(f"üìä **–ò—Ç–æ–≥–æ–≤–∞—è –≤—ã–∂–∏–º–∫–∞:**\n\n{final_summary}", parse_mode="Markdown")
    else:
        await message.edit_text("üìä **–ù–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.**", parse_mode="Markdown")

